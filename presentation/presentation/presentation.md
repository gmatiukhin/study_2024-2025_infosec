---
## Front matter
lang: ru-RU
title: "Ошибки проверки вводимых данных: инъекция кода"
subtitle: 
author:
  - Матюхин Г.В.
institute:
  - Российский университет дружбы народов, Москва, Россия
date: 19 октября 2024

## i18n babel
babel-lang: russian
babel-otherlangs: english

## Formatting pdf
toc: false
toc-title: Содержание
slide_level: 2
aspectratio: 169
section-titles: true
theme: metropolis
header-includes:
 - \metroset{progressbar=frametitle,sectionpage=progressbar,numbering=fraction}
---

# Что такое инъекция кода

Инъекция кода — это уязвимость безопасности, возникающая, когда злоумышленник вводит или «инъектирует» вредоносный код в приложение, позволяя ему выполнять несанкционированные команды, изменять данные или получить доступ к системным ресурсам. 

## Цели инъекций кода:

- Изменение данных: Произвольное изменение значений в базе данных.
- Установка вредоносного ПО: Инъекция серверного кода (например, PHP).
- Повышение привилегий: Эксплуатация уязвимостей в оболочке.
- Атаки на пользователей: Инъекции HTML/скриптов (XSS).

## Доброкачественное использование

- Добавить полезный новый столбец, который не был предусмотрен в оригинальном дизайне страницы с результатами поиска.
- Предложить новый способ фильтрации, сортировки или группировки данных с использованием поля,
    которое не было доступно в исходных функциях дизайна.
- В программе, подобной Dropbox, добавить специальные компоненты,
    которые могут использоваться для подключения к онлайн-ресурсам в оффлайн-программе.
- Использовать динамический линкер Linux для определения функции с тем же именем,
    что и определённые функции библиотеки Libc,
    подключить эту функцию как библиотеку и переопределить использование функций Libc.

## Непреднамеренное использование

- То, что пользователь считает допустимым вводом, может содержать символы или строковые маркеры,
    зарезервированные разработчиками для специального значения
    (например, символ "&" в "Shannon & Jason" или кавычки в "Bob 'Slugger' McCracken").
- Пользователь может отправить некорректный файл в качестве ввода,
    который нормально обрабатывается в одной программе, но становится проблемным для другой системы.

# Примеры инъекции кода

# Межсайтовый скриптинг (XSS)

XSS (Cross-Site Scripting) -- это тип уязвимости веб-приложений,
который позволяет злоумышленнику внедрить вредоносный код (обычно JavaScript)
в веб-страницу, которую просматривают другие пользователи.

# Виды XSS:

## Reflected XSS (отражённый XSS):

Происходит, когда вредоносный скрипт внедряется в запрос
и немедленно отражается на странице без сохранения в базе данных.

Пример:

- Злоумышленник отправляет жертве ссылку на веб-сайт с параметром `search`,
 содержащим вредоносный код:

 ```html
 https://example.com/search?q=<script>alert('XSS');</script>
 ```
- Когда жертва переходит по ссылке, сервер возвращает страницу с результатами поиска,
 содержащими вредоносный скрипт.

## Stored XSS (сохранённый XSS):

Вредоносный код сохраняется на сервере (например, в базе данных)
и отображается другим пользователям при просмотре скомпрометированных данных.

Пример:

- Злоумышленник оставляет комментарий на сайте с внедрённым JavaScript-кодом:

 ```html
 <script>alert('Your session is hijacked');</script>
 ```
- Этот код будет выполняться всякий раз, когда другие пользователи просматривают этот комментарий.

## DOM-based XSS:

Уязвимость возникает непосредственно в клиентской части (в браузере),
когда JavaScript на странице небезопасно обрабатывает данные из URL 
или других источников.

Пример:

- Страница использует JavaScript для динамического изменения DOM на основе данных в URL:

 ```javascript
 document.write(location.href);
 ```

- Если пользователь перейдёт по ссылке:

 ```html
 https://example.com/#<script>alert('DOM XSS');</script>
 ```

- Вредоносный скрипт будет выполнен в контексте страницы.

# Инъекция команд

## Пример уязвимого bash-скрипта:

```bash
#!/bin/bash
if [ $1 == 1 ]; then echo "it matches"; fi
```

## Инъекция

```bash
$ ./check.sh "$(evil_command; echo 1)"
it matches
```

## Любая программа потенциально уязвима

Любая функция, которая может составлять и выполнять команду оболочки,
потенциально уязвима для атак через инъекцию в оболочку.

Например:

- `subprocess.run()` в Python
- `system()` в C
- `std::process::Command::new()` в Rust
- `exec.Command()` в Java

## Экранирование

- `shlex.quote()` в Python
- `Shellwords.escape()` в Ruby
- `shlex::quote()` в Rust
- `StringEscapeUtils.escapeJava()` в Java

# Чтение стека format-строкой

## Пример программы

```c
#include <stdio.h>

int main() {
    char user_input[100];
    char password[10] = "Password1";

    fgets(user_input, sizeof(user_input), stdin);

    printf(user_input); // Safe version is: printf("%s", user_input);
    printf("\n");

    return 0;
}
```

## Пример инъекции

```bash
$ echo "%x %x %x %x %x %x %x %x" | ./printf
6b8596b1 fbad2088 4f5a6c21 6b8596c8 1 25207825 20782520 78252078
```

```bash
$ echo "%x %x %x %x .. %s .. %x %x %x" | ./printf
3446d6b1 fbad2088 6b03fc21 3446d6c8 .. Password1 .. 25207825 a782520 4115e4b8
```

# Устранение инъекций

## Стратегии безопасной обработки ввода и вывода, такие как:

- Использование защищеных от всех вводимых символов API
- Валидация или "санитарная" очистка ввода
- Кодирование ввода, экранирование опасных символов
- Кодирование вывода, чтобы предотвратить атаки инъекций HTML (XSS) против посетителей сайта.
- Установка флага `HttpOnly` для HTTP Cookies

## Продвинутое обнаружение инъекций

- Валидация хешей образа в реальном времени
- Использование бита NX
- "Канарейки" - случайное размещение значений в стеке.
- Маскирование указателей на код (CPM) в C

# Выводы

Несмотря на известные риски, понимание и реализация эффективных стратегий защиты
могут существенно снизить вероятность атак, связанных с инъекцией кода.
